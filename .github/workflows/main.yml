name: Build Kivy APK

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v3
      with:
        python-version: '3.8'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install kivy buildozer cython

    - name: Set up Java
      uses: actions/setup-java@v3
      with:
        java-version: '8'
        distribution: 'adopt'

    - name: Install Android SDK
      run: |
        sudo apt-get update
        sudo apt-get install -y openjdk-8-jdk libssl-dev libffi-dev libtool libnss3-dev libssl-dev libreadline-dev libffi-dev curl libbz2-dev python3-openssl build-essential
        sudo apt-get install -y acpid adwaita-icon-theme alsa-ucm-conf android-libaapt:amd64 android-libbacktrace:amd64 android-libboringssl:amd64 android-liblog:amd64 android-libutils:amd64 android-sdk-build-tools-common ant antlr apport apport-symptoms apt apt-utils at-spi2-core automake base-files bash bc bind9-dnsutils bind9-libs:amd64 binutils-common:amd64 bnd bpfcc-tools bsdextrautils btrfs-progs busybox-initramfs byobu bzip2-doc ca-certificates-java chrony cloud-init cloud-initramfs-dyn-netconf cmake-data console-setup coreutils cpp cpp-13-x86-64-linux-gnu cron cryptsetup cryptsetup-initramfs dash dbus-bin dbus-session-bus-common dbus-user-session dconf-service debconf-i18n default-jdk-headless default-jre-headless diffutils distro-info dmeventd dmsetup dpkg dracut- e2fsprogs-l10n ec2-hibinit-agent ed eject f2fs-tools fdisk finalrd fontconfig fonts-dejavu-core fonts-dejavu-mono fonts-liberation-sans-narrow fonts-ubuntu-console ftp fwupd g++ g++-13-x86-64-linux-gnu gawk gcc-13 gcc-13-x86-64-linux-gnu gcc-x86-64-linux-gnu gettext gir1.2-girepository-2.0:amd64 gir1.2-packagekitglib-1.0 git-man gnupg-l10n google-android-build-tools-34.0.0-er google-android-emulator-er google-android-ndk-r25b-er google-android-tools-er gpg-agent gpgconf gpgv graphviz groff-base grub-common grub-efi-amd64-signed grub-pc grub2-common gtk-update-icon-cache hdparm hicolor-icon-theme htop hwdata ieee-data info init-system-helpers initramfs-tools-bin -info intltool-debian iptables iputils-tracepath iso-codes ivy java-wrappers jq kbd keyboxd kmod krb5-locales less libacl1:amd64 libaio1t64:amd64 libalgorithm-diff-xs-perl:amd64 libann0 libaom3:amd64 libapache-pom-java libapparmor1:amd64 libapt-pkg-perl libarchive13t64:amd64 libargs4j-java libasm-java libasound2t64:amd64 libasyncns0:amd64 libatinject-jsr330-api-java libatk-wrapper-java libatk1.0-0t64:amd64 libatomic1:amd64 libattr1:amd64 libaudit1:amd64 libavahi-common-data:amd64 libbcel-java libbcprov-java libbinutils:amd64 libblockdev-crypto3:amd64 libblockdev-loop3:amd64 libblockdev-nvme3:amd64 libblockdev-swap3:amd64 libblockdev3:amd64 libbpfcc:amd64 libbsd0:amd64 libbsh-java libbytesize1:amd64 libbz2-dev:amd64 libc-dev-bin libc6:amd64 libc6-i386 libcairo2:amd64 libcap2:amd64 libcbor0.10:amd64 libcdi-api-java libcgraph6:amd64 libclang1-18 libcolord2:amd64 libcommons-cli-java libcommons-collections3-java libcommons-io-java libcommons-lang3-java libcommons-parent-java libcrypt1:amd64 libctf-nobfd0:amd64 libcups2t64:amd64 libcurl4t64:amd64 libdb5.3t64:amd64 libdconf1:amd64 libde265-0:amd64 libdeflate0:amd64 libdevmapper1.02.1:amd64 libdpkg-perl libdrm-common libdrm-nouveau2:amd64 libdrm2:amd64 libduktape207:amd64 libeatmydata1:amd64 libedit2:amd64 libefivar1t64:amd64 libelf1t64:amd64 liberror-perl libestr0:amd64 libevent-core-2.1-7t64:amd64 libexpat1-dev:amd64 libfakeroot:amd64 libfastjson4:amd64 libfelix-framework-java libfelix-osgi-obr-java libffi-dev:amd64 libfido2-1:amd64 libfindbugs-java libflashrom1:amd64 libfreetype6:amd64 libftdi1-2:amd64 libfwupd2:amd64 libgail18t64:amd64 libgcc-s1:amd64 libgd3:amd64 libgdbm-dev:amd64 libgdk-pixbuf-2.0-0:amd64 libgdk-pixbuf2.0-common libgeronimo-interceptor-3.0-spec-java libgirepository-1.0-1:amd64 libgl1-amber-dri:amd64 libglapi-mesa:amd64 libglib2.0-bin libglvnd0:amd64 libglx0:amd64 libgnutls30t64:amd64 libgoogle-gson-java libgpg-error-l10n libgpgme11t64:amd64 libgprofng0:amd64 libgradle-plugins-java libgssapi-krb5-2:amd64 libgtk-3-0t64:amd64 libgtk-3-common libgtk2.0-bin libgts-0.7-5t64:amd64 libguava-java libguice-java libgvc6 libhamcrest-java libhawtjni-runtime-java libheif-plugin-aomenc:amd64 libheif1:amd64 libhogweed6t64:amd64 libhttpcore-java libibverbs1:amd64 libice6:amd64 libidn2-0:amd64 libintl-perl libip4tc2:amd64 libisl23:amd64 libistack-commons-java libjansi-java libjansi1-java libjarjar-java libjavaewah-java libjaxb-java libjbig0:amd64 libjcifs-java libjcommander-java libjetty9-java libjgit-java libjna-java libjpeg-turbo8:amd64 libjq1:amd64 libjs-sphinxdoc libjsch-java libjson-glib-1.0-0:amd64 libjsoncpp25:amd64 libjsp-api-java libjsr305-java libk5crypto3:amd64 libklibc:amd64 libkrb5-3:amd64 libkryo-java libkxml2-java liblcms2-2:amd64 libldap2:amd64 libllvm17t64:amd64 liblmdb0:amd64 liblogback-java libltdl-dev:amd64 liblvm2cmd2.03:amd64 liblzma5:amd64 libmagic-mgc libmail-sendmail-perl libmaven-parent-java libmaven-shared-io-java libmaven3-core-java libmbim-glib4:amd64 libmbim-utils libminlog-java libmnl0:amd64 libmodule-scandeps-perl libmp3lame0:amd64 libmpfr6:amd64 libmspack0t64:amd64 libnative-platform-java libncurses-dev:amd64 libncursesw6:amd64 libnetfilter-conntrack3:amd64 libnettle8t64:amd64 libnfnetlink0:amd64 libnftnl11:amd64 libnl-3-200:amd64 libnl-route-3-200:amd64 libnspr4:amd64 libnss-systemd:amd64 libnss3-dev:amd64 libnuma1:amd64 libobjenesis-java libonig5:amd64 libonnx1t64:amd64 libopus0:amd64 libosgi-compendium-java libp11-kit0:amd64 libpam-cap:amd64 libpam-modules-bin libpam-systemd:amd64 libpango-1.0-0:amd64 libpangoft2-1.0-0:amd64 libpathplan4:amd64 libpci3:amd64 libpcre2-8-0:amd64 libperl5.38t64:amd64 libpixman-1-0:amd64 libplexus-archiver-java libplexus-classworlds-java libplexus-container-default-java libplexus-io-java libplexus-utils2-java libpng16-16t64:amd64 libpolkit-gobject-1-0:amd64 libpopt0:amd64 libproc2-0:amd64 libprotobuf-c1:amd64 libprotobuf-lite32t64:amd64 libprotoc32t64:amd64 libpthread-stubs0-dev:amd64 libpython3-dev:amd64 libpython3.12-dev:amd64 libpython3.12-stdlib:amd64 libqdox-java libqmi-proxy libqrtr-glib0:amd64 libreadline-dev:amd64 libreflectasm-java libregexp-assemble-perl librelaxng-datatype-java librhino-java librsvg2-2:amd64 librtmp1:amd64 libsasl2-modules:amd64 libseccomp2:amd64 libsemanage-common libsensors-config libsepol2:amd64 libsframe1:amd64 libsharpyuv0:amd64 libsimple-http-java libsisu-plexus-java libslf4j-java libsm6:amd64 libsnappy-java libsnappy1v5:amd64 libsodium23:amd64 libsqlite3-0:amd64 libssh-4:amd64 libssl3t64:amd64 libstdc++-13-dev:amd64 libstemmer0d:amd64 libsys-hostname-long-perl libsystemd0:amd64 libtcl8.6:amd64 libtext-charwidth-perl:amd64 libtext-wrapi18n-perl libthai0:amd64 libtinfo6:amd64 libtirpc3t64:amd64 libtraceevent1:amd64 libtracefs1:amd64 libtss2-esys-3.0.2-0t64:amd64 libtss2-sys1t64:amd64 libtss2-tcti-device0t64:amd64 libtss2-tcti-swtpm0t64:amd64 libubsan1:amd64 libudev1:amd64 libunistring5:amd64 liburcu8t64:amd64 libutempter0:amd64 libuv1t64:amd64 libvorbis0a:amd64 libvulkan1:amd64 libwagon-http-java libwayland-client0:amd64 libwayland-egl1:amd64 libwebsocket-api-java libx11-6:amd64 libx11-dev:amd64 libxau-dev:amd64 libxaw7:amd64 libxcb-dri2-0:amd64 libxcb-glx0:amd64 libxcb-randr0:amd64 libxcb-shape0:amd64 libxcb-sync1:amd64 libxcb1:amd64 libxcomposite1:amd64 libxdamage1:amd64 libxdmcp6:amd64 libxext6:amd64 libxft2:amd64 libxinerama1:amd64 libxkbfile1:amd64 libxml-commons-resolver1.1-java libxmlb2:amd64 libxmlsec1t64-openssl:amd64 libxmuu1:amd64 libxpp3-java libxrender1:amd64 libxslt1.1:amd64 libxstream-java libxt6t64:amd64 libxtst6:amd64 libxxf86dga1:amd64 libxxhash0:amd64 libyaml-0-2:amd64 libzopfli1 linux-aws linux-aws-tools-6.8.0-1016 linux-headers-6.8.0-1016-aws linux-image-6.8.0-1016-aws linux-libc-dev:amd64 linux-tools-6.8.0-1016-aws locales logrotate lsb-release lsof lvm2 lxd-er make manpages mawk media-types microcode-initrd mokutil mount multipath-tools ncurses-base ncurses-term netbase netplan-generator networkd-dispatcher ntfs-3g open-iscsi openjdk-11-jdk-headless:amd64 openjdk-17-jdk:amd64 openjdk-17-jre:amd64 openjdk-21-jdk-headless:amd64 openjdk-21-jre-headless:amd64 openjdk-8-jdk-headless:amd64 openjdk-8-jre-headless:amd64 openssh-server openssl overlayroot packagekit-tools passwd patch pciutils perl-base pinentry-curses pkgconf:amd64 plymouth po-debconf pollinate procps protobuf-compiler publicsuffix python-babel-localedata python3-apport python3-attr python3-babel python3-blinker python3-certifi python3-chardet python3-colorama python3-configobj python3-cryptography python3-debconf python3-dev python3-distro-info python3-gdbm:amd64 python3-hamcrest python3-hyperlink python3-incremental python3-json-pointer python3-jsonschema python3-launchpadlib python3-lazr.uri python3-markdown-it python3-mdurl python3-netaddr python3-netplan python3-oauthlib python3-pexpect python3-pip-whl python3-problem-report python3-ptyprocess python3-pyasn1-modules python3-pyparsing python3-requests python3-serial python3-setuptools python3-six python3-systemd python3-typing-extensions python3-update-manager python3-wadllib python3-yaml python3.12 python3.12-minimal readline-common rsync run-one screen sed session-migration sg3-utils-udev shared-mime-info snap software-properties-common sqlite3 ssh-import-id sudo systemd systemd-hwe-hwdb systemd-sysv tar tcl8.6 telnet thin-provisioning-tools tmux tpm-udev tzdata ubuntu-kernel-accessories ubuntu-minimal ubuntu-pro-client ubuntu-release-upgrader-core ubuntu-standard udev ufw unzip update-notifier-common usb-modeswitch-data usbutils uuid-runtime vim-common vim-tiny whiptail x11-utils xauth xfsprogs xml-core xtrans-dev xz-utils zip zlib1g-dev:amd64 zsh-common
        wget https://dl.google.com/android/repository/commandlinetools-linux-6858069_latest.zip
        mkdir -p $HOME/android-sdk/cmdline-tools
        unzip commandlinetools-linux-6858069_latest.zip -d $HOME/android-sdk/cmdline-tools
        mkdir -p $HOME/android-sdk/cmdline-tools/latest
        mv $HOME/android-sdk/cmdline-tools/cmdline-tools/* $HOME/android-sdk/cmdline-tools/latest/
        echo ">>===== creating sdkmanager script =====================================<<"
        echo "`realpath $HOME/android-sdk/cmdline-tools/latest/bin/sdkmanager` --sdk_root=`realpath $HOME/android-sdk` \$*" | tee sdkmanager
        chmod +x sdkmanager; 
        sudo ln -s $HOME/android-sdk/cmdline-tools/latest  $HOME/android-sdk/tools
        echo -e "y\ny\ny\ny\ny\ny\ny" > input.txt
        sudo cp sdkmanager /usr/bin; 
        echo ">>===== testing sdkmanager script =====================================<<"
        sudo sdkmanager --licenses < input.txt

    - name: Install Autoconf and Libtool
      run: sudo apt-get install autoconf libtool

    - name: Run Autoupdate
      run: autoupdate

    - name: Build the APK
      run: |
        python -m pip install --upgrade pip
        pip install kivy buildozer cython
        sed -i 's/# (str) Title of the application/(str) Title of the application/' buildozer.spec
        sed -i 's/# (str) Package name/(str) Package name/' buildozer.spec
        sed -i 's/# (str) Source code where the main.py live/(str) Source code where the main.py live/' buildozer.spec
        sed -i 's/# (list) Application requirements/(list) Application requirements/' buildozer.spec
        sed -i 's/# (str) Supported orientation/(str) Supported orientation/' buildozer.spec
        sed -i 's/# (list) Permissions/(list) Permissions/' buildozer.spec
        buildozer -v android debug

    - name: Archive APK
      uses: actions/upload-artifact@v3
      with:
        name: kivy-app
        path: bin/*.apk
